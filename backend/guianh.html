<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Test Chat Nh√≥m</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <h2>üîê Nh·∫≠p Th√¥ng Tin Ng∆∞·ªùi D√πng</h2>
  <label>Token:</label><br>
  <input type="text" id="token" placeholder="Nh·∫≠p JWT Token..." style="width: 500px;"><br><br>

  <label>User ID:</label><br>
  <input type="text" id="userId" placeholder="Nh·∫≠p userId..." style="width: 300px;"><br><br>

  <label>Group ID:</label><br>
  <input type="text" id="groupId" placeholder="Nh·∫≠p groupId..." style="width: 300px;"><br><br>

  <button onclick="connect()">üîå K·∫øt n·ªëi v√† T·∫£i tin nh·∫Øn</button>

  <hr>
  <h3>üí¨ Tin nh·∫Øn</h3>
  <div id="chatBox" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;"></div>

  <form id="textForm">
    <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." required />
    <button type="submit">G·ª≠i</button>
  </form>

  <form id="imageForm" enctype="multipart/form-data">
    <input type="file" name="image" required />
    <button type="submit">G·ª≠i ·∫£nh/File</button>
  </form>

  <script>
    let socket;
    let currentGroupId = null;
    let currentUserId = null;
    let currentToken = null;

    // ‚úÖ Lu√¥n tr·∫£ v·ªÅ URL tuy·ªát ƒë·ªëi cho ·∫£nh ho·∫∑c file
    function getAbsoluteUrl(url) {
      if (!url) return "";
      if (url.startsWith("http")) return url;
      return `http://localhost:8001${url}`;
    }

    function connect() {
      currentToken = document.getElementById("token").value.trim();
      currentUserId = document.getElementById("userId").value.trim();
      currentGroupId = document.getElementById("groupId").value.trim();

      if (!currentToken || !currentUserId || !currentGroupId) {
        alert("Vui l√≤ng nh·∫≠p ƒë·ªß Token, User ID v√† Group ID");
        return;
      }

      socket = io("http://localhost:8001", {
        auth: { token: currentToken }
      });

      socket.on("connect", () => {
        console.log("‚úÖ Socket connected");
        socket.emit("join-group", currentGroupId);
        loadMessages(currentGroupId);
      });

      socket.on("group-message", (msg) => {
        if (msg.groupId !== currentGroupId) return;
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML += `<p><b>${msg.senderName}:</b> ${msg.message}</p>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      socket.on("group-image", (msg) => {
        if (msg.groupId !== currentGroupId) return;
        const chatBox = document.getElementById("chatBox");

        const fileLink = getAbsoluteUrl(msg.imageUrl);
        const isImage = msg.fileType && msg.fileType.startsWith("image/");

        if (isImage) {
          chatBox.innerHTML += `
            <p><b>${msg.senderName}:</b><br/>
              <a href="${fileLink}" target="_blank">${msg.fileName || "Xem ·∫£nh"}</a><br/>
              <img src="${fileLink}" style="max-width: 200px;" />
            </p>`;
        } else {
          chatBox.innerHTML += `
            <p><b>${msg.senderName}:</b> üìé 
              <a href="${fileLink}" target="_blank">${msg.fileName || "T·ªáp ƒë√≠nh k√®m"}</a>
            </p>`;
        }

        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    async function loadMessages(groupId) {
      const res = await fetch(`http://localhost:8001/api/group/${groupId}/messages`, {
        headers: { Authorization: `Bearer ${currentToken}` },
      });
      const data = await res.json();
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";

      data.forEach(msg => {
        const sender = msg.senderName || "·∫®n danh";

        if (msg.fileName || msg.imageUrl) {
          const fileLink = getAbsoluteUrl(msg.imageUrl);
          const isImage = msg.fileType && msg.fileType.startsWith("image/");

          if (isImage) {
            chatBox.innerHTML += `
              <p><b>${sender}:</b><br/>
                <a href="${fileLink}" target="_blank">${msg.fileName || "Xem ·∫£nh"}</a><br/>
                <img src="${fileLink}" style="max-width: 200px;" />
              </p>`;
          } else {
            chatBox.innerHTML += `
              <p><b>${sender}:</b> üìé 
                <a href="${fileLink}" target="_blank">${msg.fileName || "T·ªáp ƒë√≠nh k√®m"}</a>
              </p>`;
          }
        } else {
          chatBox.innerHTML += `<p><b>${sender}:</b> ${msg.message}</p>`;
        }
      });

      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById("textForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const message = document.getElementById("messageInput").value;
      if (!currentGroupId || !message) return;

      await fetch(`http://localhost:8001/api/group/${currentGroupId}/messages`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${currentToken}`
        },
        body: JSON.stringify({ message })
      });

      document.getElementById("messageInput").value = "";
    });

    document.getElementById("imageForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentGroupId) return;

      const formData = new FormData(document.getElementById("imageForm"));
      await fetch(`http://localhost:8001/api/group/${currentGroupId}/sendImageMessage`, {
        method: "POST",
        headers: { Authorization: `Bearer ${currentToken}` },
        body: formData
      });

      document.getElementById("imageForm").reset();
    });
  </script>
</body>
</html>
